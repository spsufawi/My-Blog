---
title: 用R分析三国志系列武将数据
author: Xinchen Pan
date: '2018-03-25'
slug: RoTC-Analysis
categories:
  - Data Analysis
tags:
  - R
---

写这篇文章有两个原因，第一个是最近在看吴秀波演的《军师联盟》，这部剧剧情紧凑，演员演技精湛，有很多令人惊艳的细节， 重新勾起了我对三国的兴趣。从小到大玩过不少三国游戏，看过很多三国的书，电视剧如央视版三国，高希希版新三国也都不在话下，而这些年除了偶尔玩玩《三国志10》并没有再对三国有什么研究。第二个原因是自己有比较长一段时间没怎么写R, 工作上用到R的机会也不是很多，手有点生，打算用这个数据练练手，加之这是个中文数据，以前没有过用R处理中文数据的经验。

人物数值系统一直是光荣历史游戏的一个特点，它是光荣结合史实，小说，野史等资料对人物的一个全面评价。光荣公司的《三国志》系列可以说是最经典的三国游戏，从1985年第一代推出以来，到现在已经有了十三代作品。而每代出场的数百个武将，经过这么多个版本，他们的各项属性是否会有什么大的变化呢，而这些变化反映了什么呢，这也是这次分析主要想研究的。

我用的武将数据是一个台湾网友（cws0324@yahoo.com.tw）收集制作的，它包含了三国志 1-11 所有的武将数据。给人物以数值化好处自然不言而喻，它可以让我们对游戏中武将的强弱有个直观的了解，但坏处就是我们有时候只看重数值，而忽略了该人物在历史上真实的一面。E.g. 伊达政宗，竹中半兵卫。关于这个问题，请参考 [国内非专业圈中（民科？）日本战国时代历史学习的氛围和现状有感](https://zhuanlan.zhihu.com/p/23140678)

马伯庸在知乎一个问题的回答里做过类似的分析，他用的工具是Excel, 有兴趣的可以去看看. [光荣公司《三国志》游戏里的武将设定，是按照三国历史设计的吗？](https://www.zhihu.com/question/21530813) 

由于自己也是对演义了解的更多，所以分析的时候更多会以演义的角度，再结合史实。话不说多，开始我们的分析。

##1. 数据处理

首先看下这份数据本身的格式。
![](/content/post/RoTC-Analysis_files/attr.png)

我们发现有多个相同的变量分部在不同的列，而且版本信息占据了多个格子。这种数据不手动处理很难读进R（可能可以？），在excel里也许能很方便的分析处理，但在R里这不属于我们所说的[干净数据](http://r4ds.had.co.nz/tidy-data.html)。干净数据有如下定义

1. 每一个变量必须有它自己的列
2. 每一个样本必须有它自己的行
3. 每一个数值必须在它自己的格子

我决定自己手动把版本数据分开到11个表格里，每一个如下图所示。(自然我也可以手动直接得到我们最终想要的数据，但我还是决定用R实现它。）
![](/post/RoTC-Analysis_files/attr1.png)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
这些是我们需要用到的package.
```{r, message=FALSE}
library(readxl)
library(dplyr)
library(data.table)
library(tibble)
library(ggplot2)
```

为了能在R里使用中文，我们用下面的代码将系统locale设置为”Chs”.
```{r, results='hide'}
Sys.setlocale('LC_ALL','Chs')
```

接着用<code>readxl::read_excel</code>读取数据，每一个版本的数据分别存在了1个data frame里，我们总共有11个data frame，而这11个data frame又都再存在一个list里，<code>lapply</code>返回的就是list结构，我们给它命名为<code>dt</code>.
```{r}
dt <- lapply(1:11, function(x) read_excel("Characters.xlsx", x)) 
```

由于每一代武将所拥有的属性不一样，为了后边方便，我希望能做一个大的data frame，它的变量有姓名，所有版本的属性以及该人物出场的版本。下面我们来看如何达到这个目的。

我先把每一个版本的数据移除不需要的变量和那一个版本没有出现过的武将，部分NPC各项属性结尾0，我们也将它去掉，把清理过后的数据存到一个新的变量里，叫做<code>series</code>, 
```{r}
series <- lapply(1:11, function(x) {select(dt[[x]], -c(2:8)) %>%
    filter(complete.cases(dt[[x]][,-c(2:8)])) %>%
    mutate(版本 =  paste0("三國志", x)) %>%
    filter(智力!= 0) })
```
第一代前六个武将是如下几位。
```{r}
head(series[[1]])
```

前边说过，每一代游戏武将拥有的属性不一样，第一代有体力，第二代把统率分成了陆指和水指, 第九代没有魅力。那我们来看下所有作品都有属性是什么，以及每一代都有的属性。

排除姓名和版本，历代都出现过的属性只有武力和智力，这两个属性也是我们后边会主要分析的。
```{r}
common_attr <- Reduce(intersect, sapply(series, colnames))
all_attr <- Reduce(union, sapply(series, colnames))
all_attr
common_attr
```

因为现在我们的11个data frame是分开的，我们需要把它们合并，但每个data frame的列数不一样，这该如何合并呢。最简单的方法就是用<code>plyr::rbind.fill()</code>， 它可以自动的把缺失值用NA补上。在用这个function之前我尝试了一个非常复杂的方法，这种方法还需要调整变量顺序，这里不多阐述了。

我还调整了版本这个categorical variable的level，使它是按照1-11代的顺序排列， 主要是为了之后做图的时候X轴的值（版本）能够按照正常顺序排列。

```{r}
series_full <- do.call(plyr::rbind.fill, series) %>%
   mutate(版本 = factor(版本, levels = paste0("三國志", 1:11))) %>%
   select(c(1,11,3:10,2))
```
现在我们得到了我们想要的这个大的data frame,它是这个样子的。
```{r}
head(series_full)
```

##2. 各项数据分析

###2.1 各代人物数量分析

先来看下各代出场的人物数量，
```{r}
char_freq <- group_by(series_full, 版本) %>% summarise(人數 = n())
char_freq
```

不出所料第一点是出场人物最少的，这些武将想必应该都是我们耳熟能详的武将吧，就像三国杀最早的标准包里只有刘关张等20几个耳熟能详的人物，而现在秦宓， 李丰这种角色都已登场。

再来看十一部作品中都出场的有多少位人物。

```{r}
show_in_all <- Reduce(intersect, lapply(series, "[", 1))
nrow(show_in_all)
```

1-11代每一代都出现的角色有221名，我们从里边随机选10个，不出意外都是你可以随便说出他的故事的角色(说出你的故事)。
```{r}
sample_n(show_in_all, 10)
```


那有哪些角色出现在了第一部，却在后边某些版本没出现呢。
```{r}
show_in_all <- Reduce(intersect, lapply(series, "[", 1))
setdiff(filter(series_full, 版本 == "三國志1")$姓名, show_in_all$姓名)
```

这些人有些也是比较出名的，比如在《三国演义》中了周瑜反间计的蒋干（没猜方片？），蜀国坚定的投降派，大学者谯周，东吴大将蒋钦，文章能治曹操头痛的建安七子之一的陈琳, 其他大部分都是小角色，韩遂，袁术的一帮子人。

###2.2. 三国君主数值对比
#### 武力对比

```{r, warning=FALSE, echo=FALSE}
emperor <- filter(series_full, 姓名 %in% c("劉備", "曹操", "孫權")) %>%
  mutate(姓名 = factor(姓名, levels = c("孫權", "劉備", "曹操")))

emperor_attr <- function(attrs){
  result <- ggplot(emperor, aes_string(x = "版本", y = attrs, 
    group = "姓名")) + 
    geom_point(size = 2, aes(color = 姓名)) + geom_line(aes(color = 姓名)) + 
    geom_text(aes_string(label = attrs), hjust = 1, vjust = -0.5) + 
    ylab(attrs) + 
    ggtitle(paste0("三國主君歷代遊戲", attrs, "對比"))
  result
}
```

```{r, fig.height=4.5, echo=FALSE}
emperor_attr("武力")
```

三国志1作为一款1985年出品的游戏，可能在人物数值上稍欠考究，在这一代中，孙权和曹操的武力达到了惊人的94，93，从网上搜寻的资料来看，曹操的武力高于一般士兵是没问题的。
<pre>
<code>
兵谋叛，夜烧太祖帐，太祖手剑杀数十人，馀皆披靡，乃得出营；其不叛者五百馀人。——《魏书》
</code>
</pre>

关于孙权的武力的描述不多，不过有记载他曾经干过老虎。虽然是用了武器。

<pre>
<code>
二十三年十月，权将如吴，亲乘马射虎於庱亭。马为虎所伤，权投以双戟，虎卻废，常从张世击以戈，
获之。——《吴传记》
</code>
</pre>
我并没有特意去查有关刘备武义的描述，三英战吕布虽然是虚构的，但我们有理由相信罗贯中的虚构大部分会建立在一定的史实基础上，如果刘备手无缚鸡之力，没拿过武器，估计情节就是双英战吕布了。而且刘备早年讨伐黄巾贼也都是身先士卒，多次亲临沙场，这也是需要勇武的。

所以孙曹刘武力都最终稳定在70上下，我认为比较科学。

####智力对比

```{r,  fig.height=4.5, echo=FALSE}
emperor_attr("智力")
```

从图中可以看到除了曹操每一代智力都稳定在90以上，孙权和刘备的智力都呈下降趋势，分别稳定在80和70左右，这还是比较合理的，一来是刘备在整部《三国演义》里都没有什么出彩的料敌制胜，智谋过人的表现，在诸葛亮出山以前长期依附着不同势力，从曹操，到袁绍，再到刘表，一直没有自己的一片根据地。当然刘备最大的招牌也不是智谋，是仁德，是能得人心，早期实力不济的时候依然选择救援公孙瓒，孔融等诸侯，带新野襄阳数十万百姓逃到江夏，这也能解释为什么关羽张飞等能一直死心塌地跟着刘备，为什么诸葛亮愿意出山。

而曹操192年领兖州牧，收黄巾贼三十万编制为青州兵，之后虽然和吕布，张绣等作战时互有胜负，但至少作为一方势力已成气候。后边能携天子令诸侯，破吕布，收徐州，败袁绍，在不到二十年的时间里统一北方，靠着是自己的大局观，战略眼光，带兵能力以及智谋。曹操手下能臣谋士虽然多，做整体战略部署谋划，拍板的还是曹操。并不是刘备集团那样寡头制，前期诸葛亮，中期一段时间诸葛亮和庞统，后边加上个法正。

孙权18岁接替他哥孙策的位置，接位初期政权不稳，多个州郡发生叛乱，就连孙权的堂兄弟都与曹操内通。而孙权此时一方面继续重用程普，张昭等老臣，一方面广纳贤才，陆逊，鲁肃，诸葛瑾都在这一时期加入了孙权阵营。在完成了江东内的平乱维稳之后，孙权将目标锁定为江夏黄祖，虽未最终攻下江夏，但也多次打败刘表军，并且最终杀死黄祖。之后赤壁之战大获全胜。再后来与曹操在濡须的战斗中，被评价为"生子当如孙仲谋"。虽然孙权一直没打下合肥，并且在逍遥津之战成就了张辽，并且在晚年因继承人问题造成了 [二宫之争](https://zh.wikipedia.org/wiki/%E4%BA%8C%E5%AE%AE%E4%B9%8B%E7%88%AD), 是孙吴折损不少人才(陆逊，步骘的死多少都与此事相关)，但人无完人，总体说来孙权在三国中是个了不起的人物。

```{r,echo=FALSE, fig.height=4.5}
emperor_attr_led <- function(attrs){
  result <- ggplot(emperor[!is.na(emperor$統率),], aes_string(x = "版本", y = attrs, 
    group = "姓名")) + 
    geom_point(size = 2, aes(color = 姓名)) + geom_line(aes(color = 姓名)) + 
    geom_text(aes_string(label = attrs), hjust = 1, vjust = -0.5) + 
    ylab(attrs) + 
    ggtitle(paste0("三國主君歷代遊戲", attrs, "對比"))
  result
}

emperor_attr_led("統率")
```

刘备和孙权的统率最终又交汇到了75左右。統率指的是带兵打仗能力，刘备一生虽然败仗打得多，但汉中之战也算是个人巅峰，孙权统治江东五十余年，一直没在曹魏的淮南地区占得便宜，虽说镇守合肥的历来都是曹魏的名将，但也稍微说明了点孙权的打仗能力。

###2.3 历代最强/最弱

####2.3.1 历代最强武力

下面这个function是用来算历代游戏中各人物进入最强武力，最强智力，最弱武力等等top10的次数。

```{r}
top_low_attr <- function(attrs, bw = 1){
  col_name <- enquo(attrs) 
  result <- series_full %>% group_by(版本) %>% 
    top_n(n = bw * 10, !!col_name) %>% 
    group_by(姓名) %>%
    summarise(次數 = n(), 均值 = ceiling(mean(!!col_name))) %>%
    arrange(desc(次數), desc(均值)) %>%
    slice(1:10)
    result
}
```
这跨越了21年的11代游戏里，武力最强者是否有很大变化。从下边这个表格来看，吕布，关羽，张飞，马超，许褚这五个人每一次都进入了最强武力top 10。其它四人也都没有悬念，但太史慈5次进入top这让我有点意外。太史慈出道作品是北海救孔融，成名之作是和孙策的单挑，加入东吴后成功镇压刘磐，总体说来还是十分勇武的，放在游戏中武力必然90保底，没想到光荣给过多次95以上。

注：这武力均值是该角色进入前10的时候的武力值的平均数

```{r}
top_low_attr(武力)
```
####2.3.2 历代最高智力

把左慈这个神棍去掉的话就有失悬念了，唯一意外的是诸葛亮有一次没进前十，有可能是我的代码没考虑第十名并列的情况，不过诸葛亮智力怎么会排到第十？
```{r}
top_low_attr(智力)
```

那我们来看下是哪一代诸葛亮掉队了。原來是第七部，这部游戏的人物数值设计师看来是个诸葛亮黑，或者他把诸葛亮其他能力调高了？
```{r}
series_full %>% filter(姓名 == "諸葛亮")  %>%
  select("智力", "版本")
```

嚯，原来如此，在历代诸葛亮武力都在5，60，甚至3,40的情况下，第七部诸葛亮一跃成为了一名武力为87的武将，有理想相信这是光荣为了平衡而nerf的决定。
```{r}
series_full %>% filter(姓名 == "諸葛亮") 
```
####2.3.3 历代最弱智力

提到兀突骨可能有人不认识，但估计都知道诸葛亮七擒孟获，孟获被抓了六次之后第七次找的藤甲兵援军的老大就是他。(我一直把他和沙摩柯搞混了)。兀酱是三国演义虚构的角色，虽然自己的三万人中了诸葛亮的火攻全军覆没，也不至于智力在11作游戏中九次排倒数吧，为兀突骨鸣不平。

这表格中少数部落的人占了50%，兀突骨，忙牙长，金环三结，孟优都是南蛮人，拥有三国演义最喜感名字的俄何燒戈是羌族武将（迷当大王不服）。演义中基本南蛮羌人作为援军出场的下场都不太好。刘备伐吴请来的沙摩柯被周泰所杀，雅丹和越吉一个被活捉一个被杀，接着就是俄何烧戈了（历史上俄何和烧戈是两个人）。

```{r}
top_low_attr(智力, -1)
```

其它人物没太多可说的。蔡和，被曹操喊去卧底，估计一身演技还没施展，就被周瑜识破了。
上将潘凤打不过华雄为啥智力那么低，何况也是韩馥让他去的，他的大斧饥渴难耐那是电视剧给他加的台词。都怪罗贯中。

<pre>
<code>
“末将遵命！取兵器来！” 央视版三国
“小小娃娃口出狂言，我乃潘凤，快来送死！” 《貂蝉》
“华雄的拳在真正天才的眼里，不过是慢动作而已。” 《终极三国》
“有何不敢？我的大斧早就饥渴难耐了！” 《三国》
</code>
</pre>

####2.3.4 历代最差魅力

宦官黄皓，佞臣岑昏入围比较没悬念，演义中被描述成”平生性急，轻于杀戮，众皆恶之“的韩玄，卖了张鲁协助曹军最后却身首异处的杨松，投降东吴的糜芳都比较合理。
```{r}
top_low_attr(魅力, -1)
```


###2.4 智勇双全

####2.4.1 有勇有谋
下面来看下在武力比智力高的人里智力最高的是谁
```{r}
war_int <- series_full %>% filter(武力 > 智力) %>% 
  group_by(版本) %>%
  top_n(n = 1, 智力) %>%
  select(c("姓名", "武力", "智力"))

table(war_int$姓名)
```

孙策，赵云\(\times 3\)，张辽\(\times 4\), 徐盛，张任, 郝昭，这些确实都是三国里最厉害的一群人物。

####2.4.2 文武双全

智力比武力高的人里武力最高的会有谁。
```{r}
int_war <- series_full %>% filter(智力 >= 武力) %>% 
  group_by(版本) %>%
  top_n(n = 1, 武力) %>%
  select(c("姓名", "武力", "智力"))

table(int_war$姓名)
```
基本都是姜伯约，不过光荣公司把姜维的武力智力调换下相信也不会有人有意见。


再来看下武力+智力最高的人是谁，是否和上边的人物有所出入
```{r}
war_int2 <- series_full %>%  mutate(智勇 = 智力 + 武力) %>%
  group_by(版本) %>%
  top_n(n = 1, 智勇)
table(war_int2$姓名) 
```
基本没区别。

###2.5 五虎大将 vs 五子良将

最后来对比下蜀国五虎大将和五子良将吧。先来放一张光荣风格的武将头像图。

![](/content/post/RoTC-Analysis_files/wuhua-vs-wuzi.jpg)
五子良将指的是魏国将领张辽，徐晃，乐进，张郃，于禁。这个称号来自陈寿的《三国志》
<pre>
<code>
太祖建茲武功，而時之良將，五子為先 --陈寿 《三国志魏志卷十七》
</code>
</pre>

正史上并没有记载有五虎将这个称号，陈寿将关羽，张飞，赵云，黄忠，马超合编到了《三国志·蜀书·关张马黄赵传》中，后来人们就以此构想出了五虎上将，可能也是受到了五子良将的启发。

####2.5.1 武力对比

```{r}
wuzi <- c("張郃", "徐晃", "張遼", "于禁", "樂進")
wuhu <- c("關羽", "張飛", "趙雲", "馬超", "黃忠")

general <- series_full %>% filter(姓名 %in% c(wuzi, wuhu)) %>% 
  mutate(稱呼 = ifelse(姓名 %in% wuzi, "五子良將", "五虎大將"))

wuhu_vs_wuzi <- function(attrs){
  ggplot(general, aes_string(x = "版本", y = attrs, group = "姓名")) + 
    geom_point(size = 2, aes(color = 稱呼)) + 
    geom_line(aes(color = 稱呼)) +
    geom_text(data = filter(general, 版本 == "三國志1"), 
      aes(label = 姓名, hjust = 1, vjust = -1)) +
    ggtitle(paste0("五子良將和五虎大將歷代", attrs, "對比"))
}
```


```{r, fig.width=7}
wuhu_vs_wuzi("武力")
```

从这个图来看基本五虎武力是碾压五子的，而五子里又属张辽徐晃武力最高。前者没有什么好说的，毕竟关羽赵飞的“万人敌”的称号是《三国志魏书程昱传》里记载的。赵云先不说在历史上真实的表现如何，就凭他在演义里长坂坡，汉水拒敌的表现，光荣就不敢不给赵云95以下的武力。五虎将的武力基本没什么变化，维持在95左右。乐进和于禁的武力在2代一度跌破60，后边走高达到了80多。

张辽前边已经说过不少，我们来看下曹丕，孙权对他的评价。
<pre>
<code>
曹丕：「此亦古之召虎也。」「合肥之役，遼、（李）典以步卒八百，破賊十萬，自古用兵，未之有也。
      使賊至今奪氣，可謂國之爪牙矣。其分遼、典邑各百戶，賜一子爵關內侯。」
孫權：「張遼雖病，不可當也，慎之！
</code>
</pre>

徐晃主要的战绩是潼关之战和樊城之战， 潼关之战率军先渡黄河为曹军主力部队铺路，击败梁兴。


